<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Salesforce Chat Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --capella-red: #C10016;
      --capella-red-dark: #910012;
    }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      padding: 40px;
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      color: var(--capella-red);
    }

    /* Your branded circular launcher */
    #capellaChatBtn {
      background-image: url("https://www.capella.edu/content/dam/capella/chat/chat_btn_hover.png");
      background-color: transparent;
      background-size: cover;
      width: 54px;
      height: 54px;
      border-radius: 50%;
      position: fixed;
      right: 50px;
      bottom: 35px;
      z-index: 3141591;
      border: none;
      cursor: pointer;
      text-indent: -9999px;
      overflow: hidden;
      transition: transform 0.2s ease;
    }
    #capellaChatBtn:hover {
      transform: scale(1.05);
    }
    #capellaChatBtn:focus {
      outline: 2px solid var(--capella-red);
      outline-offset: 2px;
    }
  </style>
</head>
<body>
  <h1>Welcome to Salesforce Messaging Test</h1>
  <p>Click the chat button in the bottom right corner to start a conversation.</p>
  <p><strong>Prechat information is automatically configured:</strong></p>
  <ul>
    <li><strong>Email:</strong> dogz@mailinator.com</li>
    <li><strong>First Name:</strong> Chat</li>
    <li><strong>Last Name:</strong> TestUser</li>
    <li><strong>Subject:</strong> Chat Inquiry from Website</li>
  </ul>
  <div style="background: #d1ecf1; padding: 16px; border-left: 4px solid #17a2b8; margin-top: 20px; border-radius: 4px;">
    <h3 style="margin-top: 0; color: #0c5460;">üêõ Debugging Mode Active</h3>
    <p><strong>Open Browser Console (F12) to see detailed logs:</strong></p>
    <ul>
      <li>Event firing sequence</li>
      <li>Prechat API availability checks</li>
      <li>Field values being sent</li>
      <li>Expected routingAttributes structure</li>
      <li>Success/error messages</li>
    </ul>
    <p style="background: #fff; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 12px;">
      <strong>After testing, run:</strong><br>
      <code>console.log(window.prechatDebug)</code>
    </p>
    <p><strong>WHAT TO LOOK FOR IN CONSOLE:</strong></p>
    <ol style="font-size: 14px;">
      <li>‚úÖ <code>setHiddenPrechatFields called successfully</code></li>
      <li>üåê <code>NETWORK: POST /conversation detected</code></li>
      <li>‚úÖ <code>routingAttributes found in request!</code></li>
      <li>üìß <code>Email value: dogz@mailinator.com</code></li>
    </ol>
    <div style="background: #fff3cd; padding: 8px; border-left: 3px solid #856404; margin-top: 8px;">
      <strong>‚ùå If you see:</strong> <code>routingAttributes MISSING from request</code>
      <br><strong>Then:</strong> setHiddenPrechatFields is not working correctly
    </div>
    <pre style="background: #fff; padding: 8px; border-radius: 4px; font-size: 11px; overflow-x: auto; margin-top: 8px;">
Expected /conversation POST payload:
{
  "routingAttributes": {
    "_firstName": "Chat",
    "_lastName": "TestUser",
    "_email": "dogz@mailinator.com",
    "_subject": "Chat Inquiry from Website"
  },
  "conversationId": "...",
  "language": "en_US"
}</pre>
  </div>

  <!-- Your branded launcher -->
  <button id="capellaChatBtn" aria-label="Chat with us">Chat</button>

  <script>
    // DEBUG: Track all prechat attempts
    window.prechatDebug = {
      attempts: [],
      events: [],
      networkRequests: []
    };

    // CRITICAL: Intercept and inject prechat data into conversation request
    const originalFetch = window.fetch;
    window.fetch = function(...args) {
      const url = args[0];
      let options = args[1];

      // Inject prechat data into /conversation request
      if (url && url.includes('/conversation')) {
        console.log('üåê NETWORK: POST /conversation detected');

        if (options && options.body) {
          try {
            const body = JSON.parse(options.body);
            console.log('üì§ Original request payload:', JSON.stringify(body, null, 2));

            // CRITICAL: Only inject into conversation CREATION requests (not queries)
            // Conversation creation requests have: conversationId, language, routingAttributes
            if (body.conversationId && body.language) {
              console.log('‚úÖ This is a conversation CREATION request');

              // Check if routingAttributes is empty or missing
              if (!body.routingAttributes || Object.keys(body.routingAttributes).length === 0) {
                console.log('‚ö†Ô∏è routingAttributes is empty - INJECTING prechat data!');

                // Inject our prechat data
                body.routingAttributes = {
                  _firstName: 'Chat',
                  _lastName: 'TestUser',
                  _email: 'dogz@mailinator.com',
                  _subject: 'Chat Inquiry from Website'
                };

                // Update the request body with injected data
                options = {
                  ...options,
                  body: JSON.stringify(body)
                };

                console.log('‚úÖ INJECTED routingAttributes:', JSON.stringify(body.routingAttributes, null, 2));
                console.log('üì§ Modified request payload:', JSON.stringify(body, null, 2));
              } else {
                console.log('‚úÖ routingAttributes already populated!');
                console.log('üìß Email value:', body.routingAttributes._email);
              }

              window.prechatDebug.networkRequests.push({
                url: url,
                body: body,
                time: new Date().toISOString()
              });
            } else {
              console.log('‚ÑπÔ∏è This is a conversation QUERY request (not creation) - ignoring');
            }
          } catch (e) {
            console.log('Could not parse request body:', e);
          }
        }
      }

      return originalFetch.apply(this, [url, options]);
    };

    // Initialize Embedded Messaging
    function initEmbeddedMessaging() {
      try {
        console.log('üöÄ Initializing Salesforce Embedded Messaging...');
        console.log('üìã Org ID: 00DEc00000GfZ2M');
        console.log('üìã Deployment: admission_github');

        embeddedservice_bootstrap.settings.language = 'en_US';

        embeddedservice_bootstrap.init(
          '00DEc00000GfZ2M',
          'admission_github',
          'https://strategiced--qasf.sandbox.my.site.com/ESWadmissiongithub1762055730119',
          {
            scrt2URL: 'https://strategiced--qasf.sandbox.my.salesforce-scrt.com'
          }
        );

        console.log('‚úÖ Init called successfully');
      } catch (err) {
        console.error('‚ùå Error loading Embedded Messaging:', err);
      }
    }

    // IMPORTANT: Set prechat fields EARLY when messaging is ready (before button creation)
    window.addEventListener('onEmbeddedMessagingReady', () => {
      console.log('========================================');
      console.log('‚úÖ EVENT: onEmbeddedMessagingReady FIRED');
      console.log('========================================');

      window.prechatDebug.events.push({
        event: 'onEmbeddedMessagingReady',
        time: new Date().toISOString()
      });

      // Check if prechatAPI is available
      console.log('üîç Checking prechatAPI availability...');
      console.log('embeddedservice_bootstrap exists:', typeof embeddedservice_bootstrap !== 'undefined');
      console.log('prechatAPI exists:', typeof embeddedservice_bootstrap?.prechatAPI !== 'undefined');
      console.log('setHiddenPrechatFields exists:', typeof embeddedservice_bootstrap?.prechatAPI?.setHiddenPrechatFields === 'function');

      // Try ALL possible field name variations
      const prechatVariations = [
        // Variation 1: Channel Variable Names (camelCase)
        {
          name: 'Channel Variable (camelCase)',
          fields: {
            _firstName: 'Chat',
            _lastName: 'TestUser',
            _email: 'dogz@mailinator.com',
            _subject: 'Chat Inquiry from Website'
          }
        },
        // Variation 2: Flow Variable Names (PascalCase)
        {
          name: 'Flow Variable (PascalCase)',
          fields: {
            FirstName: 'Chat',
            LastName: 'TestUser',
            Email: 'dogz@mailinator.com',
            Subject: 'Chat Inquiry from Website'
          }
        }
      ];

      // Prepare the correct structure matching Salesforce's expected format
      const prechatData = {
        _firstName: 'Chat',
        _lastName: 'TestUser',
        _email: 'dogz@mailinator.com',
        _subject: 'Chat Inquiry from Website'
      };

      console.log('üìã Prechat data to send:', JSON.stringify(prechatData, null, 2));
      console.log('üìã Expected structure in routingAttributes:', JSON.stringify({
        routingAttributes: prechatData,
        language: 'en_US'
      }, null, 2));

      try {
        embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(prechatData);

        console.log('‚úÖ setHiddenPrechatFields called successfully!');
        console.log('‚úÖ Data will be wrapped in routingAttributes automatically');

        window.prechatDebug.attempts.push({
          variation: 'routingAttributes format',
          fields: prechatData,
          expectedStructure: {
            routingAttributes: prechatData,
            language: 'en_US'
          },
          success: true,
          time: new Date().toISOString()
        });
      } catch (err) {
        console.error('‚ùå Error setting prechat fields:', err);
        console.error('Error details:', {
          message: err.message,
          stack: err.stack
        });
        window.prechatDebug.attempts.push({
          variation: 'routingAttributes format',
          fields: prechatData,
          success: false,
          error: err.message,
          time: new Date().toISOString()
        });
      }

      console.log('========================================');
    });

    // Chat button created - set up custom launcher
    window.addEventListener('onEmbeddedMessagingButtonCreated', () => {
      console.log('‚úÖ Chat button created - ready to launch');

      // Hide default Salesforce button
      if (embeddedservice_bootstrap.utilAPI?.hideChatButton) {
        embeddedservice_bootstrap.utilAPI.hideChatButton();
      }

      // Set up custom button click handler
      const customBtn = document.getElementById('capellaChatBtn');
      if (customBtn) {
        customBtn.addEventListener('click', () => {
          console.log('========================================');
          console.log('üñ±Ô∏è CHAT BUTTON CLICKED');
          console.log('========================================');

          // CRITICAL: Set prechat fields RIGHT BEFORE launching chat
          // This mimics what happens when a user submits a pre-chat form
          const prechatFields = {
            _firstName: 'Chat',
            _lastName: 'TestUser',
            _email: 'dogz@mailinator.com',
            _subject: 'Chat Inquiry from Website'
          };

          console.log('üîß Setting prechat fields RIGHT BEFORE launch...');
          console.log('üìã Fields:', JSON.stringify(prechatFields, null, 2));

          try {
            // Set prechat fields immediately before launching
            embeddedservice_bootstrap.prechatAPI.setHiddenPrechatFields(prechatFields);
            console.log('‚úÖ Prechat fields set successfully BEFORE launch');

            window.prechatDebug.attempts.push({
              timing: 'Before launchChat()',
              fields: prechatFields,
              success: true,
              time: new Date().toISOString()
            });
          } catch (err) {
            console.error('‚ùå Error setting prechat before launch:', err);
          }

          // Small delay to ensure prechat data is processed
          setTimeout(() => {
            console.log('üöÄ Now launching chat...');
            embeddedservice_bootstrap.utilAPI
              .launchChat()
              .then(() => {
                console.log('‚úÖ Chat launched successfully');
                console.log('üìä All prechat attempts:', window.prechatDebug.attempts);
              })
              .catch((e) => {
                console.error('‚ùå Launch Chat failed:', e);
              });
          }, 100); // 100ms delay
        });
      }
    });

    // Conversation events
    window.addEventListener('onEmbeddedMessagingConversationStarted', (event) => {
      console.log('========================================');
      console.log('üí¨ EVENT: onEmbeddedMessagingConversationStarted');
      console.log('========================================');
      console.log('Event details:', event.detail);

      window.prechatDebug.events.push({
        event: 'onEmbeddedMessagingConversationStarted',
        time: new Date().toISOString(),
        details: event.detail
      });

      // Log all prechat attempts for debugging
      console.log('üìä PRECHAT DEBUG SUMMARY:');
      console.log('Total attempts:', window.prechatDebug.attempts.length);
      console.log('Attempts:', window.prechatDebug.attempts);
      console.log('Events:', window.prechatDebug.events);

      document.getElementById('capellaChatBtn').style.display = 'none';
    });

    window.addEventListener('onEmbeddedMessagingWindowMaximized', () => {
      document.getElementById('capellaChatBtn').style.display = 'none';
    });

    window.addEventListener('onEmbeddedMessagingWindowMinimized', () => {
      document.getElementById('capellaChatBtn').style.display = 'block';
    });

    window.addEventListener('onEmbeddedMessagingConversationClosed', () => {
      document.getElementById('capellaChatBtn').style.display = 'block';
    });
  </script>

  <!-- Salesforce bootstrap -->
  <script
    src="https://strategiced--qasf.sandbox.my.site.com/ESWadmissiongithub1762055730119/assets/js/bootstrap.min.js"
    onload="initEmbeddedMessaging()"
  ></script>
</body>
</html>
